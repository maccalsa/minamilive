<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POC HTMX + Alpine</title>
  <script src="https://unpkg.com/htmx.org@2.0.4"></script>
  <script src="https://unpkg.com/htmx-ext-ws@2.0.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    function App() {
      return {
        state: {
          user: { name: '' },
          preferences: {
            theme: localStorage.getItem('theme') || 'light'
          }
        },

        init() {
          this.loadUser();
          setInterval(() => {
            this.loadUser();
          }, 60000); // checks every minute
        },

       loadUser() {
          fetch('/api/me', { credentials: 'include' })
            .then(res => {
              if (res.status === 401) {
                console.warn('Session expired or invalid.');
                this.state.user = { name: '' };
                return Promise.reject('Session expired');
              }
              return res.json();
            })
            .then(data => {
              this.state.user = data;
            })
            .catch(err => {
              console.warn('Re-authentication required:', err);
            });
        },

        toggleTheme() {
          this.state.preferences.theme = this.state.preferences.theme === 'light' ? 'dark' : 'light';
          localStorage.setItem('theme', this.state.preferences.theme);
        },

        login() {
          console.log('Logging in...');
          fetch('/api/login', { 
            credentials: 'include',
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          })
            .then(res => {
              console.log('Login response status:', res.status);
              if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
              }
              return res.json();
            })
            .then(() => {
              console.log('Login successful, loading user...');
              this.loadUser();
            })
            .catch(error => {
              console.error('Error during login:', error);
            });
        },
        logout() {
          fetch('/api/logout', { credentials: 'include' })
            .then(() => {
              this.state.user = { name: '' };
              console.log('Logged out successfully');
            })
            .catch(err => console.error('Logout failed:', err));
        }
      }
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('HTMX version:', htmx.version);
      console.log('HTMX extensions:', htmx.extensions);
      
      let wsSocket;

      htmx.on('htmx:wsConnecting', function(evt) {
        console.log('ğŸ”„ Attempting WebSocket connection...', evt.detail);
      });

      htmx.on('htmx:wsOpen', function(evt) {
        console.log('âœ… WebSocket opened:', evt.detail.socketWrapper);
        wsSocket = evt.detail.socketWrapper;
      });

      htmx.on('htmx:wsClose', function(evt) {
        console.log('âŒ WebSocket closed:', evt.detail.socketWrapper);
        wsSocket = null;
      });

      htmx.on('htmx:wsError', function(evt) {
        console.error('ğŸš« WebSocket error:', evt.detail.error);
      });

      htmx.on('htmx:wsBeforeMessage', function(evt) {
        console.log('ğŸ“¥ Message received:', evt.detail.message);
      });

      htmx.on('htmx:wsAfterMessage', function(evt) {
        console.log('ğŸ“¤ Message processed:', evt.detail.message);
      });

      // To send messages later (from the browser console or elsewhere):
      window.sendWSMessage = function(msg) {
        if (!wsSocket) {
          console.error('ğŸš« WebSocket not initialized');
          return;
        }
        
        wsSocket.send(msg);
        console.log('ğŸ“¨ Message sent:', msg);
      }
    });
  </script>
</head>

<body x-data="App()" x-init="init()" hx-ext="ws">
  <nav>
    Welcome, <span x-text="state.user.name || 'Guest'"></span>
  </nav>

  <button @click="toggleTheme">
    Switch to <span x-text="state.preferences.theme === 'light' ? 'dark' : 'light'"></span> mode
  </button>

  <div ws-connect="ws://localhost:8000/ws/notifications">
    <div id="notifications">No notifications yet.</div>
  </div>

  <button @click="login">Login</button>
  <button @click="logout">Logout</button>

  <div x-show="!state.user.name">
    Your session expired. Please <button @click="login">Login</button> again.
  </div>

</body>
</html>
